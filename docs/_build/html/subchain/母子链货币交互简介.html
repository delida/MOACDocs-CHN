

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="chn" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="chn" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>应用链与基础链之间的跨链交互简介 &mdash; MOACdocs-chn  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="应用链上多合约的进阶操作" href="多合约的进阶操作.html" />
    <link rel="prev" title="关闭应用链" href="关闭子链.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> MOACdocs-chn
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/index.html">MOAC系统介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../moac/index.html">MOAC区块链系统和工具</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">应用链</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="名词解释.html">名词解释</a></li>
<li class="toctree-l2"><a class="reference internal" href="子链要点.html">应用链要点</a></li>
<li class="toctree-l2"><a class="reference internal" href="部署子链前的准备工作.html">部署应用链前的准备工作</a></li>
<li class="toctree-l2"><a class="reference internal" href="子链的部署方法.html">应用链的部署方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="子链业务逻辑的部署.html">应用链业务逻辑的部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="子链的监听及子链接口调用.html">应用链的监听及应用链接口调用</a></li>
<li class="toctree-l2"><a class="reference internal" href="子链节点的更替.html">应用链节点的更替</a></li>
<li class="toctree-l2"><a class="reference internal" href="关闭子链.html">关闭应用链</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">应用链与基础链之间的跨链交互简介</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#moac">母链MOAC和应用链原生币交互</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">应用链部署准备</a></li>
<li class="toctree-l4"><a class="reference internal" href="#subchainbase">subchainbase 部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dappbase">dappbase合约部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dapp">dapp 充值</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">dapp 提币</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#erc20">母链ERC20和应用链原生币交互</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">应用链部署准备</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">erc20 部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">subchainbase 部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">dappbase合约部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">dapp 充值</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">dapp 提币</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ato">ATO方式</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="多合约的进阶操作.html">应用链上多合约的进阶操作</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../restapi/index.html">Restful API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sdk/index.html">SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dapps/index.html">DAPPs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MOACdocs-chn</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">应用链</a> &raquo;</li>
        
      <li>应用链与基础链之间的跨链交互简介</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/subchain/母子链货币交互简介.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>应用链与基础链之间的跨链交互简介<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>墨客支持有币应用链，并且提供母链货币和应用链原生币之间的兑换。</p>
<p>当前，墨客提供三种类型的母应用链货币交互，以下一一介绍</p>
<div class="section" id="moac">
<h2>母链MOAC和应用链原生币交互<a class="headerlink" href="#moac" title="Permalink to this headline">¶</a></h2>
<p>这个是最基础的一种货币兑换。使用者可以在主链上充值MOAC，然后最早在下一个flush周期在应用链上获取应用链原生币。同理，使用者可以提出应用链原生币，并最早在下一个flush周期获得主链MOAC。</p>
<p>对应release中的ASM版本包</p>
<div class="section" id="id2">
<h3>应用链部署准备<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>参考应用链部署章节，完成部署应用链的准备工作。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">应用链操作账号</span><span class="p">:</span> <span class="mh">0x87e369172af1e817ebd8d63bcd9f685a513a6736</span>
<span class="n">vnode矿池合约地址</span><span class="p">:</span> <span class="mh">0x22f141dcc59850707708bc90e256318a5fe0b928</span>
<span class="n">vnode代理地址</span><span class="p">:</span> <span class="mh">0xf103bc1c054babcecd13e7ac1cf34f029647b08c</span>    <span class="mf">192.168</span><span class="o">.</span><span class="mf">10.209</span><span class="p">:</span><span class="mi">50062</span>
<span class="n">应用链矿池合约地址</span><span class="p">:</span> <span class="mh">0xe42f4f566aedc3b6dd61ea4f70cc78d396130fac</span>
<span class="n">scs0</span><span class="p">:</span> <span class="mh">0x075447a6df1fde4f39243bc67a945312ff36c193</span>  <span class="n">确保启动并加入应用链矿池</span>
<span class="n">scs1</span><span class="p">:</span> <span class="mh">0x7932f827c90c5f06c0177f642a07edfa73ee3044</span>  <span class="n">确保启动并加入应用链矿池</span>
<span class="n">scs2</span> <span class="n">兼</span> <span class="n">monitor</span><span class="p">:</span> <span class="mh">0xa5966600efb221097ce6a8ba1dc6eb1d5b43ef83</span>  <span class="n">确保启动并加入应用链矿池</span>
</pre></div>
</div>
</div>
<div class="section" id="subchainbase">
<h3>subchainbase 部署<a class="headerlink" href="#subchainbase" title="Permalink to this headline">¶</a></h3>
<p>注意这个应用链合约在官方基础上进行了修改，对应v1目录下的SubChainBase.sol（带tokensupply和exchangerate参数）。
部署SubChainBase.sol示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt; chain3 = require(&#39;chain3&#39;)
&gt; solc = require(&#39;solc&#39;)
&gt; chain3 = new chain3();
&gt; chain3.setProvider(new chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;));
&gt; input = {&#39;&#39;: fs.readFileSync(&#39;SubChainBase.sol&#39;, &#39;utf8&#39;), &#39;SubChainProtocolBase.sol&#39;: fs.readFileSync(&#39;SubChainProtocolBase.sol&#39;, &#39;utf8&#39;)};
&gt; output = solc.compile({sources: input}, 1);
&gt; abi = output.contracts[&#39;:SubChainBase&#39;].interface;
&gt; bin = output.contracts[&#39;:SubChainBase&#39;].bytecode;
&gt; proto = &#39;0xe42f4f566aedc3b6dd61ea4f70cc78d396130fac&#39; ;    // 应用链矿池合约
&gt; vnodeProtocolBaseAddr = &#39;0x22f141dcc59850707708bc90e256318a5fe0b928&#39; ;       // Vnode矿池合约
&gt; min = 1 ;                     // 应用链需要SCS的最小数量，当前需要从如下值中选择：1，3，5，7
&gt; max = 11 ;            // 应用链需要SCS的最大数量，当前需要从如下值中选择：11，21，31，51，99
&gt; thousandth = 1 ;                      // 千分之几
&gt; flushRound = 40 ;             // 应用链刷新周期  单位是主链block生成对应数量的时间（10秒一个block）
&gt; tokensupply = 1000;    // 应用链原生币总额
&gt; exchangerate = 100;           // 与moac兑换比例
&gt; SubChainBaseContract = chain3.mc.contract(JSON.parse(abi));
&gt; chain3.personal.unlockAccount(chain3.mc.accounts[0], &#39;123456&#39;);
&gt; SubChainBase = SubChainBaseContract.new( proto, vnodeProtocolBaseAddr, min, max, thousandth, flushRound, tokensupply, exchangerate { from: chain3.mc.accounts[0],  data: &#39;0x&#39; + bin,  gas:&#39;9000000&#39;} , function (e, contract){console.log(&#39;Contract address: &#39; + contract.address + &#39; transactionHash: &#39; + contract.transactionHash); });
</pre></div>
</div>
<p>部署完毕后, 获得应用链合约地址  0xe9463e215315d6f1e5387a161868d7d0a4db89e8</p>
<dl class="docutils">
<dt>验证：</dt>
<dd><div class="first last line-block">
<div class="line">访问应用链合约的 BALANCE 与 tokensupply 对应</div>
<div class="line">应该是10的21次方 : 即 tokensupply * 10的18次方(应用链原生币decimals)</div>
</div>
</dd>
</dl>
<p>调用示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">subchainaddr</span> <span class="o">=</span> <span class="s1">&#39;0xe9463e215315d6f1e5387a161868d7d0a4db89e8&#39;</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">SubChainBase</span> <span class="o">=</span> <span class="n">SubChainBaseContract</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">subchainaddr</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">SubChainBase</span><span class="o">.</span><span class="n">BALANCE</span><span class="p">()</span>
</pre></div>
</div>
<p>调用monitor的方法 ScsRPCMethod.GetBalance 查询对应部署账号地址的余额，应该也等于10的21次方</p>
</div>
<div class="section" id="dappbase">
<h3>dappbase合约部署<a class="headerlink" href="#dappbase" title="Permalink to this headline">¶</a></h3>
<p>应用链开放注册后，待scs开始出块即成功完成部署应用链，方法请参见&quot;应用链的部署方法&quot;。
按照多合约部署步骤，需要首先部署dappbase合约，方法请参见&quot;应用链业务逻辑的部署&quot;。</p>
<p># 注意部署dappbase合约的value为 1000(tokensupply) * 10的18次方(应用链原生币decimals)</p>
<p>部署示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">chain3</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;chain3&#39;</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">solc</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;solc&#39;</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">chain3</span> <span class="o">=</span> <span class="n">new</span> <span class="n">chain3</span><span class="p">();</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">setProvider</span><span class="p">(</span><span class="n">new</span> <span class="n">chain3</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">HttpProvider</span><span class="p">(</span><span class="s1">&#39;http://localhost:8545&#39;</span><span class="p">));</span>
<span class="o">&gt;</span> <span class="n">solfile</span> <span class="o">=</span> <span class="s1">&#39;DappBase.sol&#39;</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">contract</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">readFileSync</span><span class="p">(</span><span class="n">solfile</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">solc</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">abi</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="s1">&#39;:DappBase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interface</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="nb">bin</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="s1">&#39;:DappBase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bytecode</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">chain3</span><span class="o">.</span><span class="n">toSha</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">subchainaddr</span> <span class="o">=</span> <span class="s1">&#39;0xb877bf4e4cc94fd9168313e00047b77217760930&#39;</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">via</span> <span class="o">=</span> <span class="s1">&#39;0xf103bc1c054babcecd13e7ac1cf34f029647b08c&#39;</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">personal</span><span class="o">.</span><span class="n">unlockAccount</span><span class="p">(</span><span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;123456&#39;</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">sendTransaction</span><span class="p">({</span><span class="n">from</span><span class="p">:</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span><span class="n">chain3</span><span class="o">.</span><span class="n">toSha</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span><span class="s1">&#39;mc&#39;</span><span class="p">),</span> <span class="n">to</span><span class="p">:</span> <span class="n">subchainaddr</span><span class="p">,</span> <span class="n">gas</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="n">gasPrice</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shardingFlag</span><span class="p">:</span> <span class="s2">&quot;0x3&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="s1">&#39;0x&#39;</span> <span class="o">+</span> <span class="nb">bin</span><span class="p">,</span> <span class="n">nonce</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="n">via</span><span class="p">:</span> <span class="n">via</span> <span class="p">});</span>
</pre></div>
</div>
<dl class="docutils">
<dt>验证:</dt>
<dd><div class="first last line-block">
<div class="line">调用monitor的方法 ScsRPCMethod.GetNonce  Nonce值应该是1</div>
<div class="line">调用monitor的方法 ScsRPCMethod.GetBalance 查询对应dappbase合约地址的余额，应该等于10的21次方</div>
<div class="line">调用monitor的方法 ScsRPCMethod.GetBalance 查询对应部署账号地址的余额，应该等于0</div>
<div class="line">调用monitor的方法 ScsRPCMethod.GetReceipt 传入对应Nonce，从contractAddress字段内容获得合约地址</div>
</div>
</dd>
</dl>
</div>
<div class="section" id="dapp">
<h3>dapp 充值<a class="headerlink" href="#dapp" title="Permalink to this headline">¶</a></h3>
<p>调用 subchainbase 的 buyMintToken方法充值， 用户账号为发出sendTransaction的账号 数量为sendTransaction的amount参数</p>
<p>调用示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">根据ABI</span> <span class="n">chain3</span><span class="o">.</span><span class="n">sha3</span><span class="p">(</span><span class="s2">&quot;buyMintToken()&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x6bbded701cd78dee9626653dc2b2e76d3163cc5a6f81ac3b8e69da6a057824cb</span>
        <span class="n">取前4个字节</span> <span class="mh">0x6bbded70</span>
<span class="o">&gt;</span> <span class="n">amount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">subchainaddr</span> <span class="o">=</span> <span class="s1">&#39;0xe9463e215315d6f1e5387a161868d7d0a4db89e8&#39;</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">personal</span><span class="o">.</span><span class="n">unlockAccount</span><span class="p">(</span><span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;123456&#39;</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">sendTransaction</span><span class="p">(</span> <span class="p">{</span> <span class="n">from</span><span class="p">:</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="n">chain3</span><span class="o">.</span><span class="n">toSha</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span><span class="s1">&#39;mc&#39;</span><span class="p">),</span> <span class="n">to</span><span class="p">:</span> <span class="n">subchainaddr</span><span class="p">,</span> <span class="n">gas</span><span class="p">:</span><span class="s2">&quot;2000000&quot;</span><span class="p">,</span> <span class="n">gasPrice</span><span class="p">:</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">gasPrice</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="s1">&#39;0x6bbded70&#39;</span><span class="p">});</span>
</pre></div>
</div>
<dl class="docutils">
<dt>验证：</dt>
<dd><div class="first last line-block">
<div class="line">检查账号的moac是否减少:    &gt; chain3.mc.getBalance(chain3.mc.accounts[1])</div>
<div class="line">检查应用链的token是否增加:  调用monitor的方法 ScsRPCMethod.GetBalance 获得应用链chain3.mc.accounts[1]地址对应token</div>
<div class="line">检查应用链dappbase合约地址的原生币是否减少:  调用monitor的方法 ScsRPCMethod.GetBalance</div>
</div>
</dd>
</dl>
</div>
<div class="section" id="id3">
<h3>dapp 提币<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p><strong>请注意data前需要加上dappbase合约地址</strong></p>
<dl class="docutils">
<dt>调用 dappbase合约 的 redeemFromMicroChain方法，用户账号为发出sendTransaction的账号 数量为sendTransaction的amount参数</dt>
<dd><div class="first last line-block">
<div class="line">redeemFromMicroChain方法将用户账号和对应token数量加入推送结构体redeem，等待一轮flush后生效</div>
</div>
</dd>
</dl>
<p>调用示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>根据ABI chain3.sha3(&quot;redeemFromMicroChain()&quot;) = 0x89739c5bf1ef36273bf0e7aeb59ffe71213a58e1f01965e75662cb21b03abb13
取前4个字节 0x89739c5b
调用dapp合约方法，需要再data前加入dappaddr
&gt; nonce = 1       // 调用ScsRPCMethod.GetNonce获得
&gt; subchainaddr = &#39;0x1195cd9769692a69220312e95192e0dcb6a4ec09&#39;;
&gt; dappbassaddr = dappbase合约地址
&gt; via = &#39;0xf103bc1c054babcecd13e7ac1cf34f029647b08c&#39;;
&gt; amount = 10  // 对应应用链原生币  10 * 18次方    即0.1 moac
&gt; chain3.personal.unlockAccount(chain3.mc.accounts[1], &#39;123456&#39;);
&gt; chain3.mc.sendTransaction( { nonce: nonce, from: chain3.mc.accounts[1], value:chain3.toSha(amount,&#39;mc&#39;), to: subchainaddr, gas:0, shardingFlag:&#39;0x1&#39;, data: dappbassaddr + &#39;89739c5b&#39;, via: via,});
</pre></div>
</div>
<dl class="docutils">
<dt>验证：</dt>
<dd><div class="first last line-block">
<div class="line">检查账号的moac是否增加:    &gt; chain3.mc.getBalance(chain3.mc.accounts[1])</div>
<div class="line">检查应用链的token是否减少:  调用monitor的方法 ScsRPCMethod.GetBalance 获得应用链token</div>
<div class="line">检查应用链dappbase合约地址的原生币是否增加:  调用monitor的方法 ScsRPCMethod.GetBalance</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="section" id="erc20">
<h2>母链ERC20和应用链原生币交互<a class="headerlink" href="#erc20" title="Permalink to this headline">¶</a></h2>
<p>这是非常通用的一种货币兑换。使用者可以使用预先已经部署好的ERC20，或者当场部署一个主链ERC20，和应用链的原生币进行兑换。</p>
<p>对应release中的AST版本包</p>
<div class="section" id="id4">
<h3>应用链部署准备<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>参考应用链部署章节，完成部署应用链的准备工作。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">应用链操作账号</span><span class="p">:</span> <span class="mh">0x87e369172af1e817ebd8d63bcd9f685a513a6736</span>
<span class="n">vnode矿池合约地址</span><span class="p">:</span> <span class="mh">0x22f141dcc59850707708bc90e256318a5fe0b928</span>
<span class="n">vnode代理地址</span><span class="p">:</span> <span class="mh">0xf103bc1c054babcecd13e7ac1cf34f029647b08c</span>    <span class="mf">192.168</span><span class="o">.</span><span class="mf">10.209</span><span class="p">:</span><span class="mi">50062</span>
<span class="n">应用链矿池合约地址</span><span class="p">:</span> <span class="mh">0xe42f4f566aedc3b6dd61ea4f70cc78d396130fac</span>
<span class="n">scs0</span><span class="p">:</span>   <span class="mh">0xd81043d85c9c959d2925958c54c1a49c7bfd1fc8</span>  <span class="n">确保启动并加入应用链矿池</span>
<span class="n">scs1</span><span class="p">:</span>   <span class="mh">0xe767059d768fcef12e527fab63fda68cc13e24b3</span>  <span class="n">确保启动并加入应用链矿池</span>
<span class="n">scs2</span> <span class="n">兼</span> <span class="n">monitor</span><span class="p">:</span>         <span class="mh">0x0964e5d73d6a40f2fc707aa3e1361028a34923f0</span> <span class="n">确保启动并加入应用链矿池</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>erc20 部署<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>默认一个标准的erc20合约，通过allowance，transferFrom，balanceOf，transfer等标准的方法支持货币的转移。</p>
<p>参考官方示例的erc20合约erc20.sol，默认decimals为2，totalSupply为10000乘以10的2次方。
调用示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">chain3</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;chain3&#39;</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">solc</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;solc&#39;</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">chain3</span> <span class="o">=</span> <span class="n">new</span> <span class="n">chain3</span><span class="p">();</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">setProvider</span><span class="p">(</span><span class="n">new</span> <span class="n">chain3</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">HttpProvider</span><span class="p">(</span><span class="s1">&#39;http://localhost:8545&#39;</span><span class="p">));</span>
<span class="o">&gt;</span> <span class="n">solfile</span> <span class="o">=</span> <span class="s1">&#39;erc20.sol&#39;</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">contract</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">readFileSync</span><span class="p">(</span><span class="n">solfile</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">solc</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">abi</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="s1">&#39;:TestCoin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interface</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="nb">bin</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="s1">&#39;:TestCoin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bytecode</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">erc20Contract</span> <span class="o">=</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">abi</span><span class="p">));</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">personal</span><span class="o">.</span><span class="n">unlockAccount</span><span class="p">(</span><span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;123456&#39;</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">dtoken</span> <span class="o">=</span> <span class="n">erc20Contract</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="p">{</span> <span class="n">from</span><span class="p">:</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="n">data</span><span class="p">:</span> <span class="s1">&#39;0x&#39;</span> <span class="o">+</span> <span class="nb">bin</span><span class="p">,</span>  <span class="n">gas</span><span class="p">:</span><span class="s1">&#39;9000000&#39;</span><span class="p">}</span> <span class="p">,</span> <span class="n">function</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">contract</span><span class="p">){</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Contract address: &#39;</span> <span class="o">+</span> <span class="n">contract</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="s1">&#39; transactionHash: &#39;</span> <span class="o">+</span> <span class="n">contract</span><span class="o">.</span><span class="n">transactionHash</span><span class="p">);</span> <span class="p">});</span>
</pre></div>
</div>
<p>部署完毕后, 获得erc20合约地址  0x5042086887a86151945d2c2bb60628addf49d48c</p>
<p>验证： 调用合约balanceOf方法查询部署者的余额，应该是1000000</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">contractInstance</span> <span class="o">=</span> <span class="n">erc20Contract</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s1">&#39;0x5042086887a86151945d2c2bb60628addf49d48c&#39;</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">contractInstance</span><span class="o">.</span><span class="n">balanceOf</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;0x87e369172af1e817ebd8d63bcd9f685a513a6736&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>subchainbase 部署<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>注意这个应用链合约在官方基础上进行了修改，增加了erc20合约地址和兑换比例的参数
部署SubChainBase.sol示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt; chain3 = require(&#39;chain3&#39;)
&gt; solc = require(&#39;solc&#39;)
&gt; chain3 = new chain3();
&gt; chain3.setProvider(new chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;));
&gt; input = {&#39;&#39;: fs.readFileSync(&#39;SubChainBase.sol&#39;, &#39;utf8&#39;), &#39;SubChainProtocolBase.sol&#39;:fs.readFileSync(&#39;SubChainProtocolBase.sol&#39;, &#39;utf8&#39;)};
&gt; output = solc.compile({sources: input}, 1);
&gt; abi = output.contracts[&#39;:SubChainBase&#39;].interface;
&gt; bin = output.contracts[&#39;:SubChainBase&#39;].bytecode;
&gt; proto = &#39;0xe42f4f566aedc3b6dd61ea4f70cc78d396130fac&#39; ;    // 应用链矿池合约
&gt; vnodeProtocolBaseAddr = &#39;0x22f141dcc59850707708bc90e256318a5fe0b928&#39; ;       // Vnode矿池合约
&gt; ercAddr = &#39;0x5042086887a86151945d2c2bb60628addf49d48c&#39;;     // erc20合约地址
&gt; ercRate = 10;    // 兑换比率
&gt; min = 1 ;                     // 应用链需要SCS的最小数量，当前需要从如下值中选择：1，3，5，7
&gt; max = 11 ;            // 应用链需要SCS的最大数量，当前需要从如下值中选择：11，21，31，51，99
&gt; thousandth = 1 ;                      // 千分之几
&gt; flushRound = 40 ;             // 应用链刷新周期  单位是主链block生成对应数量的时间（10秒一个block）
&gt; SubChainBaseContract = chain3.mc.contract(JSON.parse(abi));
&gt; chain3.personal.unlockAccount(chain3.mc.accounts[0], &#39;123456&#39;);
&gt; SubChainBase = SubChainBaseContract.new( proto, vnodeProtocolBaseAddr, ercAddr, ercRate, min, max, thousandth, flushRound,{ from: chain3.mc.accounts[0],  data: &#39;0x&#39; + bin,  gas:&#39;9000000&#39;} , function (e, contract){console.log(&#39;Contract address: &#39; + contract.address + &#39; transactionHash: &#39; + contract.transactionHash); });
</pre></div>
</div>
<p>部署完毕后, 获得应用链合约地址  0xb877bf4e4cc94fd9168313e00047b77217760930</p>
<dl class="docutils">
<dt>验证：</dt>
<dd><div class="first last line-block">
<div class="line">访问应用链合约的 BALANCE 与 ERC20的 totalsupply 对应</div>
<div class="line">应该是10的23次方 : 即 1000000(ERC20的totalsupply) * 10(兑换比率) * 10的18次方(应用链原生币decimals) / 10的2次方(ERC20的decimals)</div>
</div>
</dd>
</dl>
<p>调用示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">subchainaddr</span> <span class="o">=</span> <span class="s1">&#39;0xb877bf4e4cc94fd9168313e00047b77217760930&#39;</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">SubChainBase</span> <span class="o">=</span> <span class="n">SubChainBaseContract</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">subchainaddr</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">SubChainBase</span><span class="o">.</span><span class="n">BALANCE</span><span class="p">()</span>
</pre></div>
</div>
<p>调用monitor的方法 ScsRPCMethod.GetBalance 查询对应部署账号地址的余额，应该等于10的23次方</p>
</div>
<div class="section" id="id7">
<h3>dappbase合约部署<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>应用链开放注册后，待scs开始出块即成功完成部署应用链，方法请参见&quot;应用链的部署方法&quot;。
按照多合约部署步骤，需要首先部署dappbase合约，方法请参见&quot;应用链业务逻辑的部署&quot;。</p>
<p>注意部署dappbase合约的value为 ERC20的totalsupply * 10(兑换比率) * 10的18次方(应用链原生币decimals) / 10的2次方(ERC20的decimals)</p>
<p>部署示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">chain3</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;chain3&#39;</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">solc</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;solc&#39;</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">chain3</span> <span class="o">=</span> <span class="n">new</span> <span class="n">chain3</span><span class="p">();</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">setProvider</span><span class="p">(</span><span class="n">new</span> <span class="n">chain3</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">HttpProvider</span><span class="p">(</span><span class="s1">&#39;http://localhost:8545&#39;</span><span class="p">));</span>
<span class="o">&gt;</span> <span class="n">solfile</span> <span class="o">=</span> <span class="s1">&#39;DappBase.sol&#39;</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">contract</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">readFileSync</span><span class="p">(</span><span class="n">solfile</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">solc</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">abi</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="s1">&#39;:DappBase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interface</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="nb">bin</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="s1">&#39;:DappBase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bytecode</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">chain3</span><span class="o">.</span><span class="n">toSha</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">subchainaddr</span> <span class="o">=</span> <span class="s1">&#39;0xb877bf4e4cc94fd9168313e00047b77217760930&#39;</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">via</span> <span class="o">=</span> <span class="s1">&#39;0xf103bc1c054babcecd13e7ac1cf34f029647b08c&#39;</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">personal</span><span class="o">.</span><span class="n">unlockAccount</span><span class="p">(</span><span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;123456&#39;</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">sendTransaction</span><span class="p">({</span><span class="n">from</span><span class="p">:</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span><span class="n">chain3</span><span class="o">.</span><span class="n">toSha</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span><span class="s1">&#39;mc&#39;</span><span class="p">),</span> <span class="n">to</span><span class="p">:</span> <span class="n">subchainaddr</span><span class="p">,</span> <span class="n">gas</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="n">gasPrice</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shardingFlag</span><span class="p">:</span> <span class="s2">&quot;0x3&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="s1">&#39;0x&#39;</span> <span class="o">+</span> <span class="nb">bin</span><span class="p">,</span> <span class="n">nonce</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="n">via</span><span class="p">:</span> <span class="n">via</span> <span class="p">});</span>
</pre></div>
</div>
<dl class="docutils">
<dt>验证:</dt>
<dd><div class="first last line-block">
<div class="line">调用monitor的方法 ScsRPCMethod.GetBalance 查询对应dappbase合约地址的余额，应该等于10的23次方</div>
<div class="line">调用monitor的方法 ScsRPCMethod.GetBalance 查询对应部署账号地址的余额，应该等于0</div>
<div class="line">调用monitor的方法 ScsRPCMethod.GetReceipt 传入对应Nonce，从contractAddress字段内容获得合约地址</div>
</div>
</dd>
</dl>
</div>
<div class="section" id="id8">
<h3>dapp 充值<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>调用 subchainbase 的 buyMintToken方法充值， 用户账号为发出sendTransaction的账号 ，参数分别为应用链合约地址和erc20的数量。
注意：buyMintToken方法首先调用erc20合约的allowance检查授权，再调用transferFrom方法将token从用户账号地址转到合约地址
所以要先调用erc20的approve方法授权对应的erc20给subchainbase合约地址。</p>
<p>调用示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">amount</span> <span class="o">=</span> <span class="mi">200</span>
<span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">erc20</span><span class="o">.</span><span class="n">approve</span><span class="o">.</span><span class="n">getData</span><span class="p">(</span><span class="n">subchainaddr</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">sendTransaction</span><span class="p">(</span> <span class="p">{</span> <span class="n">from</span><span class="p">:</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">erc20</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">gas</span><span class="p">:</span> <span class="s2">&quot;2000000&quot;</span><span class="p">,</span> <span class="n">gasPrice</span><span class="p">:</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">gasPrice</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">data</span><span class="p">});</span>
<span class="o">&gt;</span> <span class="n">subchainaddr</span> <span class="o">=</span> <span class="s1">&#39;0xb877bf4e4cc94fd9168313e00047b77217760930&#39;</span><span class="p">;</span>
<span class="o">&gt;</span> <span class="n">SubChainBase</span> <span class="o">=</span> <span class="n">SubChainBaseContract</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">subchainaddr</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">SubChainBase</span><span class="o">.</span><span class="n">buyMintToken</span><span class="o">.</span><span class="n">getData</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">personal</span><span class="o">.</span><span class="n">unlockAccount</span><span class="p">(</span><span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;123456&#39;</span><span class="p">);</span>
<span class="o">&gt;</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">sendTransaction</span><span class="p">(</span> <span class="p">{</span> <span class="n">from</span><span class="p">:</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">subchainaddr</span><span class="p">,</span> <span class="n">gas</span><span class="p">:</span> <span class="s2">&quot;2000000&quot;</span><span class="p">,</span> <span class="n">gasPrice</span><span class="p">:</span> <span class="n">chain3</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">gasPrice</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">data</span><span class="p">});</span>
</pre></div>
</div>
<dl class="docutils">
<dt>验证：</dt>
<dd><div class="first last line-block">
<div class="line">检查账号的erc20 token是否减少200:    调用erc20合约的balanceOf方法</div>
<div class="line">检查应用链对应账号的原生币是否增加20000000000000000000:  调用monitor的方法 ScsRPCMethod.GetBalance</div>
<div class="line">检查应用链dappbase合约地址的原生币是否减少20000000000000000000:  调用monitor的方法 ScsRPCMethod.GetBalance</div>
</div>
</dd>
</dl>
</div>
<div class="section" id="id9">
<h3>dapp 提币<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p><strong>请注意data前需要加上dappbase合约地址</strong></p>
<dl class="docutils">
<dt>调用 dappbase合约 的 redeemFromMicroChain方法，用户账号为发出sendTransaction的账号 数量为sendTransaction的amount参数</dt>
<dd><div class="first line-block">
<div class="line">redeemFromMicroChain方法将用户账号和对应token数量加入推送结构体redeem，等待一轮flush后，自动会调用应用链合约的redeemFromMicroChain方法</div>
</div>
<div class="last line-block">
<div class="line">调用erc20合约的transfer给用户账号转对应的token数量</div>
</div>
</dd>
</dl>
<p>调用示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>根据ABI chain3.sha3(&quot;redeemFromMicroChain()&quot;) = 0x89739c5bf1ef36273bf0e7aeb59ffe71213a58e1f01965e75662cb21b03abb13
取前4个字节 89739c5b
调用dapp方法，需要再data前加入dappaddr
&gt; nonce = 5       // 调用ScsRPCMethod.GetNonce获得
&gt; subchainaddr = &#39;0xb877bf4e4cc94fd9168313e00047b77217760930&#39;;
&gt; dappbassaddr = dappbase合约地址
&gt; via = &#39;0xf103bc1c054babcecd13e7ac1cf34f029647b08c&#39;;
&gt; amount = chain3.toSha(10,&#39;mc&#39;)    //   * 10的2次方(ERC20的decimals) / 10(兑换比率)   100 即为对应erc20数量
&gt; chain3.personal.unlockAccount(chain3.mc.accounts[0], &#39;123456&#39;);
&gt; chain3.mc.sendTransaction( { nonce: nonce, from: chain3.mc.accounts[0], value:amount, to: subchainaddr, gas:0, shardingFlag:&#39;0x1&#39;, data: dappbassaddr + &#39;89739c5b&#39;, via: via,});
</pre></div>
</div>
<dl class="docutils">
<dt>验证：</dt>
<dd><div class="first last line-block">
<div class="line">检查账号的erc20 token是否增加100:    调用erc20合约的balanceOf方法</div>
<div class="line">等待一轮flush后，检查应用链对应账号的原生币是否减少10000000000000000000:  调用monitor的方法 ScsRPCMethod.GetBalance</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="section" id="ato">
<h2>ATO方式<a class="headerlink" href="#ato" title="Permalink to this headline">¶</a></h2>
<p>TODO</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="多合约的进阶操作.html" class="btn btn-neutral float-right" title="应用链上多合约的进阶操作" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="关闭子链.html" class="btn btn-neutral" title="关闭应用链" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2019, MOAC.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            LANGUAGE:'chn',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>